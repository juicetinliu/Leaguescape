## Intro/Context
The following document highlights the requirements for building a webapp that supplements a larger escape room/game. This webapp is essentially an online store, allowing [character]s in the game to purchase [item]s with [gold] later use the [item]s for tasks and puzzles in the physical escape room/game.
The [admin] oversees the [game], and is given special tools through the same webapp, to:
* Initialize the game state and setup/manage the [player]/[character]/[items]s
* Manage - during the game - game states, and [character]/[item] states
* View - during the game - game states, and [character]/[item] states
* End the game, and view final states
The webapp should work on both mobile/desktop, but for development purposes, we'll first develop for desktop (and build for mobile views later)
The webapp is intended to be accessed by both the [player]s and [admin] on their own devices during the game, all communicating through a central data store. For simplicity though, we'll assume all [player]s access a single desktop device, while the [admin] has access to another desktop device.

## Tech
* Firebase to host the [game] data and handle auth
* Pure Vanilla JS/HTML to build the page :)

# Definitions

## Roles
* [visitor] - we define a person plainly visting the webapp as a [visitor]. 
* [user] - A user is a [visitor] who is authenticated by Firebase. They will be able to join/create a [game]. Once in a [game], they take one of three specific roles:

### User - Game Roles
Within each valid [game] - e.g a [user] can have ONE of the following roles:
* [admin] - this is the [user] who created the [game]. They has special permissions to control the [game].
* [player] - any subsequent [user] who joins the [game] is a [player]. They have limited actions.
* [*character] - this is only accessible by the [player] with the correct login details while the [game] is in the `[Running]` state. More on this later.

## Game
Each [game] is unique - the id/password of a game can be managed by the [admin]

The follow game states define a valid [game]:
* `[Setup]` - This is when the [admin] intializes the [game] with the correct [*character]/[item]s. [player]s can also be managed (kicked out) by the [admin] before the game starts.
* `[Running]` - This is after the [admin] starts the game. Note that changes to [*character]/[item]s are still allowed during this state, both by the [player] or [admin]!
* `[End]` - This is after the [admin] ends the game. Changes are NOT allowed. This state is for review purposes!

States only progress from `[Setup]` -> `[Running]` -> `[End]`, and NOT backwards. E.g. once a game is has ended (`[End]`), it cannot be restarted.

## Database structure?
* is the uuid.

- /users
    * authId - uuid set by Firebase
    - username (string) - display name in the [game] lobby. Can be modified by the [user]
- /games
    - Contains the /players, /items, /characters and /actions collections within the [game]. This is using firestore's subcollections functionality.
    * gameId - autogenerated when creating a [game]. CANNOT be modified later after creation. Unique to each [game].
    - gamePassword (string) - autogenerated when creating a [game]. CAN be modified by the [admin] at any time.
    - createdTime (timestamp) - timestamp when the [game] was created
    - startTime (timestamp) - timestamp when the [game] progressed from `[Setup]` to `[Running]`
    - endTime (timestamp) - timestamp when the [game] progressed from `[Running]` to `[End]`
    - adminId (string) - which [user] the [admin] of this [game] is. CANNOT be modified once created.
    - gameState (string<`setup`|`running`|`end`>) - can only be modifed by the [admin] through the UI.
- /players
    * playerId - same as the /users authId!
    - isBanned (boolean) - if true, [user] cannot access the game. This can be set by the [admin] to ban a specific [user].
    - assumedCharacterId (string) - empty if not a character, characterId if [player] successfully becomes a [*character]
- /items - all fields only modifiable by the [admin] unless said otherwise.
    * itemId - uuid
    - itemNumber (number) - display field
    - name (string) - display field
    - description (string) - display field
    - quantity (number) - display field, used for purchasing later.
    - price (number) - display field, used for purchasing later.
    - prereqs (string) - csv of other itemNumbers that must be bought in the same [game] in order to buy this item. Can also be "LOCKED" for permanent lock. Empty if no requirements.
    - isSecret (boolean) - if true, item ONLY shows up in the secret shop
    - ??? - more fields TBD?
- /characters - all fields only modifiable by the [admin] unless said otherwise.
    * characterId - uuid
    - name (string) - display field
    - profileImage (string) - url of profile image (uploaded to storage)
    - emblemImage (string) - url of emblem image (uploaded to storage)
    - userId (string) - display field
    - accountNumber (string) - display field
    - accountPassword (string) - display field
    - securityQuestion (string) - display field
    - securityAnswer (string) - regex?
    - startingGold (number) - starting amount of [gold] for the [*character] once the [game] is `[running]`
    - canAccessSecret (boolean) - if the player gets access to the secret shop !!!!!!CHECK WITH GRACE!!!!!!
    - gold (number) - actual current gold balance while the [game] is `[running]`. Since purchases are 'approved' by the admin, we do NOT allow modification by other roles.
    - items (array<string>) - list of owned items by itemId
    - ??? - more fields TBD.
- /actions - message bus + activity log for later!
    * actionId - uuid
    - playerId (string) - playerId - who did this action.
    - characterId (string) - who did this action. Can be empty if it was the admin who performed this or if it was something non-character specific like logging in.
    - actionType (string<`enterGame`|`exitGame`|`loginCharacter`|`logoutCharacter`|`purchaseItem`|`withdrawGold`|`depositGold`|`purchaseItemStatus`|`withdrawGoldStatus`|`depositGoldtatus`|`playerUpdated`|`itemUpdated`|`characterUpdated`>) - 
    - actionDetails (string) - delims + message (or no content if not necessary). E.g. `purchaseItem` includes itemId and quantity.
    - activityTime (timestamp) - timestamp for when the action was taken

# Pages
Here's a brief intro for what each page will display. See "Flows" for detailed display/interaction/how pages lead to each other.

## Landing pages

Page id [who can view this page]:
* `Index` [visitor] - Shows a log in page/proceed as guest (for anonymous auth), leading to the `User` page. The `Info` page is also linked here
* `Info` [visitor/user] - Shows info about the game/more details
* `User` [user] - Displays games created by the [user], or allows the [user] to join an existing [game] or create a new [game]. 

## Game pages
The following game-related pages can only be viewed by [user]s (i.e. someone who has either just created or joined an existing [game])

Page id [what [user] role(s) can view this page]:
* `Lobby` [player] - The [player] can see brief details about the [game], as well as other [player]s.
* `Admin` [admin] - has an overall [game] state view - mostly read only. The lobby can be seen/managed here. [game]/[*character]/[item] settings can be managed during the `[Setup]` and `[Running]` states
* `Login` [player] - Allows the [player] to log in to become a [*character]
* `Character` [*character] - Main screen, with options to the following:
    * `Shop` [*character] - Shows available items, more details later
    * `Shop - secret` [*character] - Shows ALL items, more details later
    * `Bank` [*character] - Shows [gold] related details for the [*character], including [gold] balance and transaction/deposit/withdrawal history. Allows actions like depositing/withdrawing [gold].
    * `Inventory` [*character] - shows [item]s owned by the [*character]
* `Credits` [player] - shows details after the [game] is in the `[End]` state

# Flows

## Non-game Flows

### `Index` Page
A log in prompt is shown, with an option to log in as a guest (anonymous user). Log in can be also be done oauth providers later like Google! 

As mentioned earlier, there's a link to the `Info` page.

Successfully logging in leads you to the `User` page.

### `Info` Page
Empty for now - will contain details about the game! TBD.

### `User` Page
This page header should display the [user]'s name - with an option to edit it. A logout button is displayed, which will take the user back to the `Index` page and turn the [user] into as [visitor].

At the top of the page, we are presented with "Join" or "Create" game. 
* Pressing "Join" prompts the [user] for an existing [game] ID and password. Successful joins will make the [user] a [player] for that [game], and lead them to the `Lobby` page (if the game is still in the `[Setup]` state) or `Login` page (if the game is in the `[Running]` state) or `Credits` page (if the game is in the `[End]` state)
    * If the [user] enters details for an existing [game] where they are an [admin], they will enter the `Admin` page.
* Pressing "Create" will create a new [game] and make the [user] an [admin] for that [game]. They will immediately enter the `Admin` page.
Either way, successfully entering a [game] will add that [game] to the [user]'s history.

A brief history of the [user]'s past [game]s are shown at the bottom - these will be [game]s where the [user] was an [admin] or [player], allowing them to quickly join. For [game]s where the [user] was an [admin], they will directly join the game as the [admin]. For [game]s where the [user] was an [player], they will directly join the game as the [player]. 

## Game Flows
We'll use the Game states to help describe the flows.

### `Admin` Page - `[Setup]` state
When a [game] is first created by the [admin], they are presented with the `Admin` page. This page should display:
    - Header
        - [game] ID and password - necessary for other [user]s to join. The admin can edit the password here.
        - "Start Game" button - requires confirmation, but will move the [game] to the `[Running]` state
        - "Exit Game" button - which does NOT end the [game], but leads the [admin] back to the `User` page and sets the [admin] back to a [user].
    - The current lobby - which [player]s are in the [game] - with actions to kick/ban [player]s if necessary. This can be minimized.
    - Tabbed views for:
        - "Profiles": [*character] overviews in a grid of profiles. Tapping on a profile opens a preview window on the right with detailed information about each [*character]. There's an "edit" and "delete" button in the preview window to manage the selected [*character]. In the grid of profiles, the last entry is an "Add Profile" button.
            - Pressing edit/Add Profile leads to the same popover - that allows you to edit all the [*character] details.
        - "Items": [item] overviews - TBD
        - "Bank": Similar to Profiles, but with the preview window on the right showing detailed bank/[gold] information. There are options to deposit/withdraw [gold] after confirmation too. There is NO option to add/edit/delete profiles.

### `Admin` Page - `[Running]` state
After the [admin] presses "Start Game", the game is now in the `[Running]` state. The `Admin` page stays mostly the same though, with a few exceptions:
    - Header
        - The "Start Game" button now becomes "End Game" - requires confirmation again, but will move the [game] to the `[End]` state.
        - A timer is displayed, showing how long the [game] has elapsed for
        - An "Activity" button is displayed. Pressing this reveals a modal that shows notifications and actions taken by all [player]s. More on this in the `Login` and `Character` pages.
    - The current lobby and tabbed views function exactly the same.

### `Admin` Page - `[End]` state
After the [admin] presses "End Game", the game is now in the `[End]` state. The `Admin` page becomes READ-ONLY. Profiles/Items/Bank tabs have all CRUD actions disabled. The lobby can still be joined, but there is no option for the [admin] to kick/ban [player]s

### `Lobby` Page - `[Setup]` state
The `Lobby` page can ONLY be accessed by [player]s during the `[Setup]` state. 

Here, the [player] can see the [game] ID, and get a READ ONLY view of the lobby and the other [player]s in the lobby. [player]s in the lobby are identified by their [user] name. They have options to leave the [game], or update their [user] name.

Once the game is in the `Running` phase, all [player]s automatically get directed to the `Login` page.
Once the game is in the `End` phase, all [player]s automatically get directed to the `Credits` page.

### `Login` Page - `[Running]` Phase
The `Login` page can ONLY be accessed by [player]s during the `[Running]` state.

A simple log in menu is shown here. Details TBD

### `Character` Page - `[Running]` Phase
The `Character` page can ONLY be accessed by [*character]s during the `[Running]` state.

Details TBD

### `Shop` Page - `[Running]` Phase
The `Shop` page can ONLY be accessed by [*character]s during the `[Running]` state.

Details TBD

### `Shop - secret` Page - `[Running]` Phase
The `Shop - secret` page can ONLY be accessed by [*character]s during the `[Running]` state.

Details TBD

### `Bank` Page - `[Running]` Phase
The `Bank` page can ONLY be accessed by [*character]s during the `[Running]` state.

Details TBD

### `Inventory` Page - `[Running]` Phase
The `Inventory` page can ONLY be accessed by [*character]s during the `[Running]` state.

Details TBD

###  `Credits` Page - `[End]` Phase
The `Credits` page can ONLY be accessed by [player]s during the `[End]` state.

Details TBD