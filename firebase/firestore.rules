rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin(gameId) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.adminId == request.auth.uid;
    }
    
    function isActivePlayer(gameId) {
      // Check if player's public profile exists AND their private data shows they are not banned
      return exists(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)) &&
             exists(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)/privateDetails/data) &&
             !get(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)/privateDetails/data).data.isBanned;
    }
    
    function hasAssumedCharacter(gameId) {
      // Check if player has assumed any character and is active
      return isActivePlayer(gameId) &&
             get(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)/privateDetails/data).data.assumedCharacterId != '';
    }

    // Only call after hasAssumedCharacter() check.
    function canAssumedCharacterViewSecretItems(gameId) {
      let assumedCharacterId = get(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)/privateDetails/data).data.assumedCharacterId;
      return assumedCharacterId != '' && get(/databases/$(database)/documents/games/$(gameId)/characters/$(assumedCharacterId)).data.canAccessSecret == true;
    }

    function canPlayerViewSecretItems(gameId) {
      return get(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)).data.loginMode == 'secret';
    }
    
    function hasAssumedThisCharacter(gameId, characterId) {
      // Check if player has assumed this specific character and is active
      return isActivePlayer(gameId) &&
             get(/databases/$(database)/documents/games/$(gameId)/players/$(request.auth.uid)/privateDetails/data).data.assumedCharacterId == characterId;
    }

    // User rules (unchanged)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId;
    }
    
    // Game rules
    match /games/{gameId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin(gameId);
      allow delete: if isAdmin(gameId);

      // Rules for the PUBLIC player data (e.g., playerName)
      match /players/{playerId} {
        // All active players in the game can read other players' public data (like playerName for lobby)
        allow read: if isAuthenticated() && (isAdmin(gameId) || isActivePlayer(gameId));
        // A player can create their own public profile when they join
        allow create: if isAuthenticated() && (request.auth.uid == playerId && request.resource.data.loginMode == 'normal');
        allow update: if isAuthenticated() && (isAdmin(gameId) || 
                      // A player can update ONLY their own playerName
                      (request.auth.uid == playerId &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['playerName'])));
        allow delete: if isAdmin(gameId); // Only admin can delete a player's public profile

        // Rules for admin-managed player data (e.g., isBanned, assumedCharacterId)
        match /privateDetails/{detailId} { // 'detailId' would typically be 'data'
          // Only the admin can read/update/delete private data (e.g., ban status, assigned character)
          allow read: if isAuthenticated() && isAdmin(gameId);
          // A player should be able to create default private data when they join
          allow create: if isAuthenticated() && (request.auth.uid == playerId && detailId == 'data' && request.resource.data.isBanned == false && request.resource.data.assumedCharacterId == '');
          allow update: if isAdmin(gameId);
          allow delete: if isAdmin(gameId);
        }

        // Rules for the message bus from the admin to the player
        match /messagesFromAdmin/{messageId} {
          // Admin and players can read these messages
          allow read: if isAuthenticated() && (isAdmin(gameId) || request.auth.uid == playerId);
          // Only the admin can create messages to the player
          allow create: if isAdmin(gameId);
          // Only the player can update messages they receive
          allow update: if isAuthenticated() && request.auth.uid == playerId;
          allow delete: if false;
        }
      }
      
      // Character rules
      match /characters/{characterId} {
        allow read: if isAdmin(gameId) || hasAssumedThisCharacter(gameId, characterId);
        // Only admin can update character data
        allow write: if isAdmin(gameId);
      }
      
      // Item rules
      match /items/{itemId} {
        allow read: if isAdmin(gameId) || (hasAssumedCharacter(gameId) && ((
          resource.data.isSecret == true &&
            canPlayerViewSecretItems(gameId) &&
            canAssumedCharacterViewSecretItems(gameId)) || 
          resource.data.isSecret == false));
        allow write: if isAdmin(gameId);
      }

      // Action rules
      match /actions/{actionId} {
        allow read: if isAdmin(gameId);
        allow create: if isAdmin(gameId) || isActivePlayer(gameId);
        allow update: if false;
        allow delete: if false;
      }
      
      

      // Rules for the message bus from players to the admin
      match /messagesToAdmin/{messageId} {
        // Admin and the owning player can read these messages
        allow read: if isAuthenticated() && (isAdmin(gameId) || request.auth.uid == request.resource.data.fromPlayer);
        // Only the owning player can create messages to the admin
        allow create: if isAuthenticated() && (isActivePlayer(gameId) && request.auth.uid == request.resource.data.fromPlayer);
        // Only the admin can update messages they receive
        allow update: if isAdmin(gameId);
        allow delete: if false;
      }
    }
  }
}